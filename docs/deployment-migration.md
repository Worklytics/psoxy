# Deployment Migration

## Overview
This document describes how to migrate your deployment from one cloud provider to another, or
one project/account to another. It does **not** cover migrating between proxy versions.

Use cases:
  - move from a `dev` account to a `prod` account (Account / Project Migration)
  - move from a "shared" account to a "dedicated" account (Account / Project Migration)
  - move from AWS --> GCP, and vice versa (Provider Migration)

## Preparation

### Preserving Existing Infrastructure

Some data/infrastructure MUST, or at least SHOULD be preserved during your migration. Below is
an enumeration of both cases.

What you MUST preserve:
  - **`SALT` value**. This is a secret used to generate the pseudonyms. If this is lost/destroyed,
    you will be unable to link any data pseudonymized with the original salt to data you process in
    the future.
  - **value for `PSEUDONYMIZE_APP_IDS`.** This value, if set to `true` will have the proxy use a rule
    set that pseudonymizes identifiers issued by source applications themselves in some cases where
    these identifiers aren't inherently PII - but the association could be considered discoverable.
  - any **custom sanitization rules** that you've set, either in your Terraform configuration
    or directly as the value of a `RULES` environment variable, SSM Parameter, or GCP Secret.

What you SHOULD preserve:
  - **API Clients**. Whether generated by Terraform or not, the "API Client" for a data source must
    typically be authorized by a data source administrator to grant it access to the data source. As
    such, if you destroy the client, or lose its id, you'll need to coordinate with the administrator
    again to recreate it / obtain the configuration information.
  - **API Client Secrets**, if generated outside of Terraform. If you destroy/lose these values,
    you'll need to contact the data source administrator to obtain new versions.

Prior to beginning your migration, you should make a list of what existing infrastructure and/or
configuration values you intend to preserve.

## Migration Plan

The following is a rough guide on the steps you need to take to migrate your deployment.

### Phase 1 : Create New Environment
  1. Create a new Terraform configuration from scratch; run `terraform init` there (if you begin
     with one of our examples, our `init` script does this). Use the `terraform.tfvars` of your
     existing configuration as a guide for what variables to set, copying over any needed values.
  2. Run a provisional `terraform plan` and review.
  3. Find the resources in the plan that correspond to the infrastructure you intend to preserve.
     For infrastructure that is not actually moving across accounts/projects/providers (likely data
     source API Clients), you must import the existing ones to your new configuration. Do the
     following:
       - use `terraform state list` + `grep` to find the resource ID of what you want to preserve,
         eg `terraform state list | grep "\.azuread_application\."` to find your Microsoft 365 API client
       - use `terraform state show` to obtain resource ID,
         eg `terraform state show 'module.psoxy.module.msft-connection["azure-ad"].azuread_application.connector'`
       - use `terraform import` to import the existing infrastructure into your new configuration,
         using the ID from the provider. NOTE: the resource ID for the resource in your new configuration
         may differ from your old configuration, if they are based on different examples or versions
         of the Terraform modules we provide.
            eg `terraform import 'module.psoxy.module.msft-connection["azure-ad"].azuread_application.connector' <ID>`
       - keep the resource ID you found above; later use `terraform state rm` to remove the resource
         from your old configuration
  5. Optionally, run `terraform plan -out=plan.out` to create a plan file; if you send this, along
     with all the `*.tf`/`*.tfvars` files to Worklytics, we can review it and confirm that it is
     correct.
  5. Run `terraform apply` to create the new infrastructure; re-confirm that the plan is not
     re-creating any API clients/etc that you intended to preserve
  6. Via AWS / GCP console, or CLIs, move the values of any secrets/parameters that you intend to
     by directly reading the values from your old account/project, and copying them into the new
     account/project

### Phase 2: Migrate
   1. Look at the `TODO 3` files/output variables for all your connectors.  Make a mapping between
      the old values and the new values. Send this to Worklytics. It should include for each the
      proxy URLs, AWS Role to use, and any other values that are changing.
   2. Wait for confirmation that Worklytics has migrated all your connections to the new values.
      This may take 1-2 days.

### Phase 3: Destroy Old Environment
  1. for anything you imported in Phase 1, run `terraform state rm` to remove it from your old
     configuration.
       - eg, `terraform state rm 'module.psoxy.module.msft-connection["azure-ad"].azuread_application.connector'`
  2. run `terraform destroy` in the old configuration. Carefully review the plan before
     confirming.
  3. You may also destroy any API clients/etc that are managed outside of Terraform and which you
     did not migrate to the new environment.
  4. You may cleanup any configuration values, such as SSM Parameters / GCP Secrets to customize
     the proxy rules sets, that you may have created in your old host environment.

