# Webhook Collectors Spec

**ALPHA FEATURE** - This is an alpha feature, not yet available in production. Description below is for design purposes only,
and may change or not be implemented as described.

***Use case: ** on-premise / custom tools, managed in house by customers. Customers can fire webhooks from these
tools to webhook collectors, which sanitize the data (namely, consistently pseudonymizing any PII such that it's linkable
to other data sources) and collect it into bulk data storage (e.g. S3, GCS, etc), from which Worklytics can later read it
 asynchronously.

## Concept

  - **Tool Client** - Javascript or web application client, running in a user endpoint (browser, mobile, etc), that sends
    webhook payloads directly to the collector (in principle)
  - **Tool Server** - the backend server of the tool.
  - **Webhook Collector** - the instance of psoxy that collects webhooks from the Tool Client or Tool Server, and
    sanitizes the data before storing it in bulk storage (e.g. S3, GCS, etc).

## Authentication

Must ensure *integrity* of the data collected; specifically attribution of webhook to a specific *actor* (user) can be
trusted for analysis purposes.  This will primarily be done by each webhook including a signature token that can be
verified by the collector.  The signature token will be an JWT identity token generated by the Tool Server and securely
distributed to the Tool Client. It should be held by the Tool Client as a secret, equivalent to a session token/cookie.

The Tool Client will include this token in the webhook payload, and the Webhook Collector will verify it before accepting
the payload.

See [jwt.io](https://jwt.io/) for more details on how to generate and verify JWT tokens in general.  JWT
are a common identity token solution, used by many OAuth2 and OpenID Connect providers - including Microsoft, Google,
etc. 

Additional authentication checks:
   - IP range of request
   - VPC - lock collectors to ONLY being reachable from specific VPC(s)

## Data Flows

### Scenario A : Tool Client to Webhook Collector

  1. Tool Server generates a JWT identity token for the user, which is securely distributed to the Tool Client.
  2. Tool Client includes the JWT identity token in the webhook payload, sent directly to the Webhook Collector.

This is analogous to how many metric systems, such as Google Analytics, work. Some minimal server-side logic
is required to obtain the JWT identity token and distribute it to the Tool Client.

### Scenario B : Tool Server to Webhook Collector

Tool Client does NOT communicate directly with the Webhook Collector. Instead, the Tool Server sends webhook
payloads to the Webhook Collector

This requires more extensive server-side logic in the Tool Server; and may have more performance implications.

### Scenario C : Tool Client to Webhook Collector without Identity Verification

In this scenario, the Tool Client sends webhook payloads directly to the Webhook Collector, which is configured
to NOT require a JWT identity token.  This is useful when Webhook Collector can be hosted on a trusted network,
or its trust in the Tool Client can be independently established (such as with IAM/API Gateway rules in AWS)
